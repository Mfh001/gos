#!/usr/bin/env ruby

require "yaml"

source = "./src/config/protocol.yml"
target = "./src/api/protocol.go"
defines = YAML.load_file(source)

COMMON_TYPE = ['bool', 'byte', 'string', 
               'uint16', 'uint24', 'uint32', 'uint64', 
               'int16', 'int24', 'int32', 'int64',
               'float32', 'float64']
PROTOCOL_TYPE = defines.keys

header = %Q{\
/*
 * Generated by tools/gen_protocol
 */
}

#
# Generate protobuf files
#
package = "pt"
proto_dir = "./src/api/#{package}"
`mkdir -p #{proto_dir}`
target = "#{proto_dir}/protocol.proto"

File.open(target, "w") do |io|
  io.write "//Generated by tools/gen_protocol_pb\n"
  io.write %Q(syntax = "proto3";\n)
  io.write "package pt;\n"
  defines.each do |key, field_defines|
    fields = []
    idx = 0
    field_defines.each do |field, type|
      type == "float32" and type = "float"
      idx += 1
      if type.index("array-") == 0
        sub_type = type.split('-')[1]
        if PROTOCOL_TYPE.include?(sub_type)
          fields << "repeated #{sub_type} #{field} = #{idx};"
        else
          fields << "repeated #{sub_type} #{field} = #{idx};"
        end
      else
        fields << "#{type} #{field} = #{idx};"
      end
    end
    io.write %Q{
message #{key} {
    #{fields.join("\n    ")}
}
}
  end
end
`cd #{proto_dir} && protoc --go_out=. protocol.proto`

#
# Generate api map
#
target = "./src/api/pt/api_map.go"
File.open(target, "w") do |io|
  name_to_id = []
  id_to_name = []
  consts = []
  defines.keys.each_with_index do |name, idx|
    name_to_id << %Q{"#{name}": uint16(#{idx + 1})}
    id_to_name << %Q{uint16(#{idx + 1}): "#{name}"}
    consts << %Q{PT_#{name} = "#{name}"}
  end
  io.write %Q{\
#{header}
package pt

var NameToId = map[string]uint16{
    #{name_to_id.join(",\n    ")},
}

var IdToName = map[uint16]string{
    #{id_to_name.join(",\n    ")},
}

const(
    #{consts.join("\n    ")}
)
}
end
`gofmt -w #{target}`

`ruby tools/gen_protocol_pb`
`ruby tools/gen_protocol_raw`
`ruby tools/gen_protocol_json`
